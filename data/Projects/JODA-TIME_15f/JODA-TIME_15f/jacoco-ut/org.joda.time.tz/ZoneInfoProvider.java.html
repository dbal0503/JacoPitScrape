<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ZoneInfoProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Joda time</a> &gt; <a href="index.source.html" class="el_package">org.joda.time.tz</a> &gt; <span class="el_source">ZoneInfoProvider.java</span></div><h1>ZoneInfoProvider.java</h1><pre class="source lang-java linenums">/*
 *  Copyright 2001-2009 Stephen Colebourne
 *
 *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
package org.joda.time.tz;

import java.io.DataInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.lang.ref.SoftReference;
import java.util.Map;
import java.util.Set;
import java.util.TreeSet;
import java.util.concurrent.ConcurrentHashMap;

import org.joda.time.DateTimeZone;

/**
 * ZoneInfoProvider loads compiled data files as generated by
 * {@link ZoneInfoCompiler}.
 * &lt;p&gt;
 * ZoneInfoProvider is thread-safe and publicly immutable.
 *
 * @author Brian S O'Neill
 * @since 1.0
 */
public class ZoneInfoProvider implements Provider {

    /** The directory where the files are held. */
    private final File iFileDir;
    /** The resource path. */
    private final String iResourcePath;
    /** The class loader to use. */
    private final ClassLoader iLoader;
    /** Maps ids to strings or SoftReferences to DateTimeZones. */
    private final Map&lt;String, Object&gt; iZoneInfoMap;

    /**
     * ZoneInfoProvider searches the given directory for compiled data files.
     *
     * @throws IOException if directory or map file cannot be read
     */
<span class="fc" id="L56">    public ZoneInfoProvider(File fileDir) throws IOException {</span>
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">        if (fileDir == null) {</span>
<span class="nc" id="L58">            throw new IllegalArgumentException(&quot;No file directory provided&quot;);</span>
        }
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">        if (!fileDir.exists()) {</span>
<span class="nc" id="L61">            throw new IOException(&quot;File directory doesn't exist: &quot; + fileDir);</span>
        }
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">        if (!fileDir.isDirectory()) {</span>
<span class="nc" id="L64">            throw new IOException(&quot;File doesn't refer to a directory: &quot; + fileDir);</span>
        }

<span class="fc" id="L67">        iFileDir = fileDir;</span>
<span class="fc" id="L68">        iResourcePath = null;</span>
<span class="fc" id="L69">        iLoader = null;</span>

<span class="fc" id="L71">        iZoneInfoMap = loadZoneInfoMap(openResource(&quot;ZoneInfoMap&quot;));</span>
<span class="fc" id="L72">    }</span>

    /**
     * ZoneInfoProvider searches the given ClassLoader resource path for
     * compiled data files. Resources are loaded from the ClassLoader that
     * loaded this class.
     *
     * @throws IOException if directory or map file cannot be read
     */
    public ZoneInfoProvider(String resourcePath) throws IOException {
<span class="fc" id="L82">        this(resourcePath, null, false);</span>
<span class="fc" id="L83">    }</span>

    /**
     * ZoneInfoProvider searches the given ClassLoader resource path for
     * compiled data files.
     *
     * @param loader ClassLoader to load compiled data files from. If null,
     * use system ClassLoader.
     * @throws IOException if directory or map file cannot be read
     */
    public ZoneInfoProvider(String resourcePath, ClassLoader loader)
        throws IOException
    {
<span class="nc" id="L96">        this(resourcePath, loader, true);</span>
<span class="nc" id="L97">    }</span>

    /**
     * @param favorSystemLoader when true, use the system class loader if
     * loader null. When false, use the current class loader if loader is null.
     */
    private ZoneInfoProvider(String resourcePath,
                             ClassLoader loader, boolean favorSystemLoader) 
        throws IOException
<span class="fc" id="L106">    {</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if (resourcePath == null) {</span>
<span class="nc" id="L108">            throw new IllegalArgumentException(&quot;No resource path provided&quot;);</span>
        }
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (!resourcePath.endsWith(&quot;/&quot;)) {</span>
<span class="fc" id="L111">            resourcePath += '/';</span>
        }

<span class="fc" id="L114">        iFileDir = null;</span>
<span class="fc" id="L115">        iResourcePath = resourcePath;</span>

<span class="pc bpc" id="L117" title="2 of 4 branches missed.">        if (loader == null &amp;&amp; !favorSystemLoader) {</span>
<span class="fc" id="L118">            loader = getClass().getClassLoader();</span>
        }

<span class="fc" id="L121">        iLoader = loader;</span>

<span class="fc" id="L123">        iZoneInfoMap = loadZoneInfoMap(openResource(&quot;ZoneInfoMap&quot;));</span>
<span class="fc" id="L124">    }</span>

    //-----------------------------------------------------------------------
    /**
     * If an error is thrown while loading zone data, uncaughtException is
     * called to log the error and null is returned for this and all future
     * requests.
     * 
     * @param id  the id to load
     * @return the loaded zone
     */
    public DateTimeZone getZone(String id) {
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">        if (id == null) {</span>
<span class="nc" id="L137">            return null;</span>
        }

<span class="fc" id="L140">        Object obj = iZoneInfoMap.get(id);</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">        if (obj == null) {</span>
<span class="fc" id="L142">            return null;</span>
        }

<span class="fc bfc" id="L145" title="All 2 branches covered.">        if (id.equals(obj)) {</span>
            // Load zone data for the first time.
<span class="fc" id="L147">            return loadZoneData(id);</span>
        }

<span class="fc bfc" id="L150" title="All 2 branches covered.">        if (obj instanceof SoftReference&lt;?&gt;) {</span>
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L152">            SoftReference&lt;DateTimeZone&gt; ref = (SoftReference&lt;DateTimeZone&gt;) obj;</span>
<span class="fc" id="L153">            DateTimeZone tz = ref.get();</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">            if (tz != null) {</span>
<span class="fc" id="L155">                return tz;</span>
            }
            // Reference cleared; load data again.
<span class="nc" id="L158">            return loadZoneData(id);</span>
        }

        // If this point is reached, mapping must link to another.
<span class="fc" id="L162">        return getZone((String)obj);</span>
    }

    /**
     * Gets a list of all the available zone ids.
     * 
     * @return the zone ids
     */
    public Set&lt;String&gt; getAvailableIDs() {
        // Return a copy of the keys rather than an umodifiable collection.
        // This prevents ConcurrentModificationExceptions from being thrown by
        // some JVMs if zones are opened while this set is iterated over.
<span class="fc" id="L174">        return new TreeSet&lt;String&gt;(iZoneInfoMap.keySet());</span>
    }

    /**
     * Called if an exception is thrown from getZone while loading zone data.
     * 
     * @param ex  the exception
     */
    protected void uncaughtException(Exception ex) {
<span class="nc" id="L183">        Thread t = Thread.currentThread();</span>
<span class="nc" id="L184">        t.getThreadGroup().uncaughtException(t, ex);</span>
<span class="nc" id="L185">    }</span>

    /**
     * Opens a resource from file or classpath.
     * 
     * @param name  the name to open
     * @return the input stream
     * @throws IOException if an error occurs
     */
    private InputStream openResource(String name) throws IOException {
        InputStream in;
<span class="fc bfc" id="L196" title="All 2 branches covered.">        if (iFileDir != null) {</span>
<span class="fc" id="L197">            in = new FileInputStream(new File(iFileDir, name));</span>
        } else {
<span class="fc" id="L199">            String path = iResourcePath.concat(name);</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">            if (iLoader != null) {</span>
<span class="fc" id="L201">                in = iLoader.getResourceAsStream(path);</span>
            } else {
<span class="nc" id="L203">                in = ClassLoader.getSystemResourceAsStream(path);</span>
            }
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">            if (in == null) {</span>
<span class="nc" id="L206">                StringBuffer buf = new StringBuffer(40)</span>
<span class="nc" id="L207">                    .append(&quot;Resource not found: \&quot;&quot;)</span>
<span class="nc" id="L208">                    .append(path)</span>
<span class="nc" id="L209">                    .append(&quot;\&quot; ClassLoader: &quot;)</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                    .append(iLoader != null ? iLoader.toString() : &quot;system&quot;);</span>
<span class="nc" id="L211">                throw new IOException(buf.toString());</span>
            }
        }
<span class="fc" id="L214">        return in;</span>
    }

    /**
     * Loads the time zone data for one id.
     * 
     * @param id  the id to load
     * @return the zone
     */
    private DateTimeZone loadZoneData(String id) {
<span class="fc" id="L224">        InputStream in = null;</span>
        try {
<span class="fc" id="L226">            in = openResource(id);</span>
<span class="fc" id="L227">            DateTimeZone tz = DateTimeZoneBuilder.readFrom(in, id);</span>
<span class="fc" id="L228">            iZoneInfoMap.put(id, new SoftReference&lt;DateTimeZone&gt;(tz));</span>
<span class="fc" id="L229">            return tz;</span>
<span class="nc" id="L230">        } catch (IOException ex) {</span>
<span class="nc" id="L231">            uncaughtException(ex);</span>
<span class="nc" id="L232">            iZoneInfoMap.remove(id);</span>
<span class="nc" id="L233">            return null;</span>
        } finally {
            try {
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">                if (in != null) {</span>
<span class="fc" id="L237">                    in.close();</span>
                }
<span class="nc" id="L239">            } catch (IOException ex) {</span>
<span class="fc" id="L240">            }</span>
        }
    }

    //-----------------------------------------------------------------------
    /**
     * Loads the zone info map.
     * 
     * @param in  the input stream
     * @return the map
     */
    private static Map&lt;String, Object&gt; loadZoneInfoMap(InputStream in) throws IOException {
<span class="fc" id="L252">        Map&lt;String, Object&gt; map = new ConcurrentHashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L253">        DataInputStream din = new DataInputStream(in);</span>
        try {
<span class="fc" id="L255">            readZoneInfoMap(din, map);</span>
        } finally {
            try {
<span class="fc" id="L258">                din.close();</span>
<span class="nc" id="L259">            } catch (IOException ex) {</span>
<span class="fc" id="L260">            }</span>
        }
<span class="fc" id="L262">        map.put(&quot;UTC&quot;, new SoftReference&lt;DateTimeZone&gt;(DateTimeZone.UTC));</span>
<span class="fc" id="L263">        return map;</span>
    }

    /**
     * Reads the zone info map from file.
     * 
     * @param din  the input stream
     * @param zimap  gets filled with string id to string id mappings
     */
    private static void readZoneInfoMap(DataInputStream din, Map&lt;String, Object&gt; zimap) throws IOException {
        // Read the string pool.
<span class="fc" id="L274">        int size = din.readUnsignedShort();</span>
<span class="fc" id="L275">        String[] pool = new String[size];</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">        for (int i=0; i&lt;size; i++) {</span>
<span class="fc" id="L277">            pool[i] = din.readUTF().intern();</span>
        }

        // Read the mappings.
<span class="fc" id="L281">        size = din.readUnsignedShort();</span>
<span class="fc bfc" id="L282" title="All 2 branches covered.">        for (int i=0; i&lt;size; i++) {</span>
            try {
<span class="fc" id="L284">                zimap.put(pool[din.readUnsignedShort()], pool[din.readUnsignedShort()]);</span>
<span class="nc" id="L285">            } catch (ArrayIndexOutOfBoundsException ex) {</span>
<span class="nc" id="L286">                throw new IOException(&quot;Corrupt zone info map&quot;);</span>
<span class="fc" id="L287">            }</span>
        }
<span class="fc" id="L289">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>